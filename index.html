<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Bag Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; }
        .container { max-width: 1600px; margin: 1.5rem auto; padding: 1.5rem; }
        .dashboard-header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 2rem;
            border-radius: 0.75rem; margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card {
            background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .section-title {
            @apply text-xl font-bold text-gray-800 mb-4 border-b pb-2;
        }
        .collapsible-header {
            @apply text-xl font-bold text-gray-700 cursor-pointer flex justify-between items-center hover:text-blue-700 transition-colors;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.open {
            max-height: 1000px; /* Adjust as needed */
        }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;
        }
        .data-table th { background-color: #f9fafb; font-weight: 500; cursor: pointer; position: relative; }
        .data-table th .sort-icon { opacity: 0.4; }
        .data-table th.sorted-asc .sort-icon, .data-table th.sorted-desc .sort-icon { opacity: 1; color: #3b82f6; }
        .data-table th.sorted-desc .sort-icon { transform: rotate(180deg); }
        .data-table tbody tr:hover { background-color: #f0f8ff; }
        .clickable-row { cursor: pointer; }

        .ageing-category-card {
            @apply p-4 rounded-lg shadow-sm border flex flex-col justify-between items-center text-center transition duration-300 ease-in-out transform hover:-translate-y-1 cursor-pointer;
        }
        .ageing-category-card.bg-blue-category { background-color: #eff6ff; border-color: #bfdbfe; color: #1e40af; }
        .ageing-category-card.bg-orange-category { background-color: #fff7ed; border-color: #fed7aa; color: #c2410c; }
        .ageing-category-card.bg-red-category { background-color: #fee2e2; border-color: #fca5a5; color: #991b1b; }
        .ageing-category-card.bg-green-category { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; }
        .ageing-category-title { @apply text-lg font-semibold mb-2; }
        .ageing-counts { @apply text-base; }
        .ageing-counts strong { @apply text-3xl font-bold; }

        .bfsi-icon { font-size: 0.7em; vertical-align: super; margin-left: 2px; color: #0d9488; }
        .remarks-textarea { width: 100%; min-height: 60px; padding: 8px; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; resize: vertical; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header text-center relative">
            <h1 class="text-4xl font-bold">Mix Bag Analytics Dashboard</h1>
            <p class="text-blue-200 text-lg">Insights into mix bag ageing and pending clusters</p>
             <button id="exportButton" class="hidden absolute top-4 right-4 bg-white/20 text-white text-xs font-bold py-2 px-4 rounded-full hover:bg-white/30 transition-all">
                Export for Offline Use
            </button>
        </div>

        <div id="uploadSection" class="card mb-6">
            <label for="mixBagFileUpload" class="block text-gray-700 text-sm font-medium mb-2">
                Upload Mix Bag GI Pending File (CSV)
            </label>
            <div class="flex items-center space-x-4">
                <input type="file" id="mixBagFileUpload" name="mixBagFileUpload" accept=".csv"
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100
                              border border-gray-300 rounded-lg cursor-pointer"
                       required>
                <button id="uploadAndAnalyzeButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Analyze
                </button>
            </div>
            <div id="messageArea" class="mt-4 text-center"></div>
        </div>

        <div id="resultsDisplay" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="card">
                        <h2 class="section-title">MixBag Summary</h2>
                        <div id="allAgeGroupCard" class="ageing-category-card bg-green-category mb-4" data-age-category="All">
                            <div class="ageing-category-title">All Pending Bags</div>
                            <div class="ageing-counts">
                                Bags: <strong id="totalPendingBags">0</strong> |
                                WBNs: <strong id="totalPendingShipments">0</strong>
                            </div>
                        </div>
                        <div id="ageingCategories" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                     <div class="card">
                        <h3 class="text-lg font-bold">ðŸª„ Magic Filter</h3>
                        <div class="my-4">
                            <div id="filter-rules-container" class="space-y-3"></div>
                            <button id="add-rule-btn" class="mt-4 text-sm bg-blue-500 text-white py-1 px-3 rounded-md">+ Add Rule</button>
                        </div>
                        <div class="flex items-center justify-between mt-4 bg-gray-50 p-3 rounded-md">
                            <div>
                                <span class="font-semibold">Match</span>
                                <select id="filter-logic-selector" class="p-1 border rounded-md">
                                    <option value="AND">ALL</option>
                                    <option value="OR">ANY</option>
                                </select>
                                <span class="font-semibold">rules.</span>
                            </div>
                            <button id="apply-magic-filter-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="card flex flex-col">
                    <h2 class="section-title">Cluster Pending Summary</h2>
                    <div id="clusterSummaryList" class="flex-grow max-h-[520px] overflow-y-auto pr-2">
                        <p class="text-gray-600">Cluster summary will appear here after analysis.</p>
                    </div>
                </div>
            </div>
           
            <div class="card">
                <h3 class="collapsible-header" data-target="detailViewContent">
                    <span id="detailViewTitle">Detailed Bag List</span>
                    <span class="arrow-icon">â–¼</span>
                </h3>
                <div id="detailViewContent" class="collapsible-content pt-4">
                    <div id="detailViewButtons" class="mb-3 space-x-2 hidden">
                        <button id="copyAllButton" class="bg-green-500 hover:bg-green-600 text-white text-sm py-1 px-3 rounded-full">Copy All</button>
                        <button id="copyRemarksButton" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded-full">Copy Remarks</button>
                    </div>
                    <div id="detailViewList" class="max-h-[500px] overflow-y-auto pr-2">
                        <p class="text-gray-600">Click on an ageing category or cluster to see details here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-8">
        <div class="flex items-center justify-center space-x-2 text-xs text-gray-400 hover:text-gray-600 transition-colors duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM3.735 3.15A2 2 0 0 1 5.416 2h5.168a2 2 0 0 1 1.681 1.15l.623 2.391c.118.453.133.934.034 1.385l-.265 1.138a2 2 0 0 1-1.996 1.625H5.416a2 2 0 0 1-1.996-1.625L3.19 8.026c-.1-.45-.083-.932.034-1.385l.623-2.391zM4.846 5.495a.5.5 0 0 0-.447.276L2.5 11.11a.5.5 0 0 0 .447.724h10.097a.5.5 0 0 0 .447-.724l-1.9-5.339a.5.5 0 0 0-.447-.276H4.846z"/></svg>
            <p>Designed & Crafted by Rh. <span class="mx-1 opacity-50">|</span> For Internal Use Only. Not for Propagation.</p>
        </div>
    </footer>

    <script id="main-script">
        function initializeApp() {
            // --- Main App Elements ---
            const fileUploadInput = document.getElementById('mixBagFileUpload');
            const uploadAndAnalyzeButton = document.getElementById('uploadAndAnalyzeButton');
            const resultsDisplay = document.getElementById('resultsDisplay');
            const messageArea = document.getElementById('messageArea');
            const exportButton = document.getElementById('exportButton');

            // --- Data Display Elements ---
            const ageingCategoriesDiv = document.getElementById('ageingCategories');
            const totalPendingBagsSpan = document.getElementById('totalPendingBags');
            const totalPendingShipmentsSpan = document.getElementById('totalPendingShipments');
            const allAgeGroupCard = document.getElementById('allAgeGroupCard');
            const clusterSummaryListDiv = document.getElementById('clusterSummaryList');
            
            // --- Detailed View Elements ---
            const detailViewTitle = document.getElementById('detailViewTitle');
            const detailViewListDiv = document.getElementById('detailViewList');
            const detailViewButtons = document.getElementById('detailViewButtons');
            const copyAllButton = document.getElementById('copyAllButton');
            const copyRemarksButton = document.getElementById('copyRemarksButton');

            // --- Magic Filter Elements ---
            const addRuleBtn = document.getElementById('add-rule-btn');
            const applyMagicFilterBtn = document.getElementById('apply-magic-filter-btn');

            // --- App State ---
            const BAG_HQ_BASE_URL = "https://hq.delhivery.com/bag/";
            let uploadedCsvContent = null;
            let uploadedFileName = null;
            window.currentAnalysisData = null; // Use window scope for broader access

            // --- Magic Filter Configuration (Corrected) ---
            const fields = {
                'Bag ID': 'bag_id',
                'Cluster ID': 'cluster_id',
                'WBN Count': 'wbn_count',
                'Age (Hours)': 'age_hours',
                'Ageing Bracket': 'age_str',
                'BFSI Status': 'is_bfsi'
            };
            const operators = {
                'Text': [ {val:'is', lbl:'is'}, {val:'is not', lbl:'is not'}, {val:'contains', lbl:'contains'} ],
                'Numeric': [ {val:'>', lbl:'>'}, {val:'<', lbl:'<'}, {val:'==', lbl:'='}, {val:'>=', lbl:'>='}, {val:'<=', lbl:'<='} ]
            };

            // --- Initial Setup ---
            if (window.embeddedData) {
                document.getElementById('uploadSection').style.display = 'none';
                if(exportButton) exportButton.style.display = 'none';
                
                window.currentAnalysisData = window.embeddedData;
                uploadedFileName = 'offline data';
                renderAll(window.currentAnalysisData);
            }

            // --- Core Functions ---
            function showMessage(element, message, isError = false) {
                element.textContent = message;
                element.className = `mt-4 text-center p-2 rounded-md ${isError ? 'text-red-800 bg-red-100' : 'text-green-800 bg-green-100'}`;
            }

            function toggleCollapsible(event) {
                const targetId = event.currentTarget.dataset.target;
                const content = document.getElementById(targetId);
                const icon = event.currentTarget.querySelector('.arrow-icon');
                const isExpanded = content.classList.contains('open');

                if (isExpanded) {
                    content.classList.remove('open');
                    icon.innerHTML = 'â–¼';
                } else {
                    content.classList.add('open');
                    icon.innerHTML = 'â–²';
                }
            }

            function setupCollapsibleHeaders() {
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.removeEventListener('click', toggleCollapsible);
                    header.addEventListener('click', toggleCollapsible);
                });
            }

            async function analyzeData(csvContent, fileName) {
                if(uploadAndAnalyzeButton) uploadAndAnalyzeButton.disabled = true;
                if(fileUploadInput) fileUploadInput.disabled = true;
                showMessage(messageArea, 'Analyzing... Please wait.', false);
                resultsDisplay.classList.add('hidden');
                if(exportButton) exportButton.classList.add('hidden');
                
                try {
                    const payload = { file_name: fileName, csv_content: csvContent };
                    // *** MODIFIED FOR DEPLOYMENT: API URL points to the live Render service ***
                    const response = await fetch('https://mix-sight.onrender.com/api/mix-bag-analytics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to analyze data.');
                    }

                    const data = await response.json();
                    window.currentAnalysisData = data;
                    renderAll(data);
                    if(exportButton) exportButton.classList.remove('hidden');

                } catch (error) {
                    showMessage(messageArea, `Error: ${error.message}`, true);
                } finally {
                    if(uploadAndAnalyzeButton) uploadAndAnalyzeButton.disabled = false;
                    if(fileUploadInput) fileUploadInput.disabled = false;
                }
            }
            
            function renderAll(data) {
                // 1. Create a mapping from bag_id to cluster_id for data enrichment.
                const bagIdToClusterIdMap = new Map();
                if (data.cluster_details) {
                    for (const clusterId in data.cluster_details) {
                        const cluster = data.cluster_details[clusterId];
                        if (cluster.bags) {
                            cluster.bags.forEach(bag => {
                                if(bag.bag_id) {
                                   bagIdToClusterIdMap.set(bag.bag_id, clusterId);
                                }
                            });
                        }
                    }
                }

                // 2. Create the master detailed_data list and enrich it with the cluster_id.
                data.detailed_data = Object.values(data.ageing_groups).flatMap(g => g.bags).map(bag => {
                    return {
                        ...bag,
                        cluster_id: bagIdToClusterIdMap.get(bag.bag_id) || 'N/A' // Add cluster_id to each bag
                    };
                });

                // 3. Continue with the rest of the rendering
                renderAgeingAnalysis(data.ageing_groups, data.total_pending_bags, data.total_pending_shipments);
                renderClusterSummaryTable(data.cluster_details);
                resultsDisplay.classList.remove('hidden');
                setupCollapsibleHeaders();
                showMessage(messageArea, `Analysis complete for "${uploadedFileName || 'loaded data'}".`, false);
            }

            // --- Magic Filter Functions ---
            function createFilterRule() {
                const ruleId = `rule-${Date.now()}`;
                const ruleDiv = document.createElement('div');
                ruleDiv.id = ruleId;
                ruleDiv.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 items-center';
                let fieldOptions = Object.keys(fields).map(name => `<option value="${fields[name]}">${name}</option>`).join('');
                ruleDiv.innerHTML = `
                    <select name="field" class="p-2 border rounded-md bg-white">${fieldOptions}</select>
                    <select name="operator" class="p-2 border rounded-md bg-white"></select>
                    <div name="value-container" class="col-span-1 md:col-span-1"></div>
                    <button class="bg-red-500 text-white px-2 py-1 rounded-md justify-self-end text-xs">Remove</button>
                `;
                document.getElementById('filter-rules-container').appendChild(ruleDiv);

                const fieldSelect = ruleDiv.querySelector('select[name="field"]');
                const opSelect = ruleDiv.querySelector('select[name="operator"]');
                const valContainer = ruleDiv.querySelector('div[name="value-container"]');

                const updateOperatorsAndValue = () => {
                    const selectedField = fieldSelect.value;
                    const isNumeric = selectedField === 'age_hours' || selectedField === 'wbn_count';
                    
                    opSelect.innerHTML = (isNumeric ? operators.Numeric : operators.Text)
                        .map(op => `<option value="${op.val}">${op.lbl}</option>`).join('');

                    const uniqueValues = [...new Set(window.currentAnalysisData.detailed_data.map(item => item[selectedField]).filter(val => val !== null && val !== undefined))];
                    
                    if (!isNumeric && (selectedField === 'age_str' || selectedField === 'is_bfsi' || selectedField === 'cluster_id')) {
                        valContainer.innerHTML = `
                            <input name="value" list="list-${ruleId}" class="p-2 border rounded-md w-full" placeholder="Enter value...">
                            <datalist id="list-${ruleId}">
                                ${uniqueValues.map(v => `<option value="${v}"></option>`).join('')}
                            </datalist>`;
                    } else {
                        valContainer.innerHTML = `<input name="value" type="${isNumeric ? 'number' : 'text'}" class="p-2 border rounded-md w-full" placeholder="Enter value...">`;
                    }
                };

                fieldSelect.addEventListener('change', updateOperatorsAndValue);
                ruleDiv.querySelector('button').addEventListener('click', () => ruleDiv.remove());
                updateOperatorsAndValue();
            }

            function applyMagicFilter() {
                const logic = document.getElementById('filter-logic-selector').value;
                const rules = [];
                document.getElementById('filter-rules-container').querySelectorAll('.grid').forEach(ruleDiv => {
                    const field = ruleDiv.querySelector('select[name="field"]').value;
                    const operator = ruleDiv.querySelector('select[name="operator"]').value;
                    const value = ruleDiv.querySelector('input[name="value"]').value;
                    if (value) {
                        rules.push({ field, operator, value });
                    }
                });

                let filteredData = window.currentAnalysisData.detailed_data;
                if (rules.length > 0) {
                    filteredData = filteredData.filter(row => {
                        const checkRule = (rule) => {
                            const rowValue = row[rule.field];
                            if (rowValue === null || rowValue === undefined) return false;
                            
                            let value = (rule.field === 'age_hours' || rule.field === 'wbn_count') ? parseFloat(rule.value) : rule.value;
                            const rowStringValue = String(rowValue).toLowerCase();
                            const valueString = String(value).toLowerCase();

                            switch (rule.operator) {
                                case 'is':       return rowStringValue == valueString;
                                case 'is not':   return rowStringValue != valueString;
                                case 'contains': return rowStringValue.includes(valueString);
                                case '>':        return rowValue > value;
                                case '<':        return rowValue < value;
                                case '==':       return rowValue == value;
                                case '>=':       return rowValue >= value;
                                case '<=':       return rowValue <= value;
                                default:         return false;
                            }
                        };
                        return (logic === 'AND') ? rules.every(checkRule) : rules.some(checkRule);
                    });
                }
                
                renderBagTable(detailViewListDiv, filteredData, 'ageing');
                detailViewTitle.textContent = `Detailed View: ${rules.length} Magic Filter(s) Applied`;
                document.getElementById('detailViewContent').classList.add('open');
            }


            // --- UI Rendering Functions ---
            function renderAgeingAnalysis(ageingGroups, totalBags, totalShipments) {
                totalPendingBagsSpan.textContent = totalBags;
                totalPendingShipmentsSpan.textContent = totalShipments;
                allAgeGroupCard.onclick = handleAllAgeGroupClick;

                const categoriesOrder = ["0 to 1 hr", "1 to 2 hr", "2 to 2.5 hrs", "More than 2.5 hrs"];
                const categoryColors = { "0 to 1 hr": "bg-blue-category", "1 to 2 hr": "bg-orange-category", "2 to 2.5 hrs": "bg-orange-category", "More than 2.5 hrs": "bg-red-category" };
                
                ageingCategoriesDiv.innerHTML = categoriesOrder.map(category => {
                    const group = ageingGroups[category] || {bag_id_count: 0, wbn_count: 0};
                    return `
                        <div class="ageing-category-card ${categoryColors[category]}" data-age-category="${category}">
                            <div class="ageing-category-title">${category}</div>
                            <div class="ageing-counts">Bags: <strong>${group.bag_id_count}</strong> | WBNs: <strong>${group.wbn_count}</strong></div>
                        </div>`;
                }).join('');

                document.querySelectorAll('.ageing-category-card:not(#allAgeGroupCard)').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const category = e.currentTarget.dataset.ageCategory;
                        const group = window.currentAnalysisData?.ageing_groups[category];
                        if (group) {
                            detailViewTitle.textContent = `${category} Bags (${group.bag_id_count} Bags, ${group.wbn_count} WBNs)`;
                            renderBagTable(detailViewListDiv, group.bags, 'ageing');
                            document.getElementById('detailViewContent').classList.add('open');
                        }
                    });
                });
            }
            
            function handleAllAgeGroupClick() {
                const allBags = window.currentAnalysisData.detailed_data;
                detailViewTitle.textContent = `All Bags (${totalPendingBagsSpan.textContent} Bags, ${totalPendingShipmentsSpan.textContent} WBNs)`;
                renderBagTable(detailViewListDiv, allBags, 'ageing');
                document.getElementById('detailViewContent').classList.add('open');
            }

            function renderBagTable(targetDiv, bags, viewType = 'ageing') {
                if (!bags || bags.length === 0) {
                    targetDiv.innerHTML = `<p class="text-gray-600 p-4">No bags found for this selection.</p>`;
                    detailViewButtons.classList.add('hidden');
                    return;
                }

                targetDiv.innerHTML = `
                    <table class="data-table" id="detailViewTable">
                        <thead><tr>
                            <th data-sort-key="bag_id">Bag ID</th>
                            <th data-sort-key="age_hours">Age</th>
                            <th data-sort-key="wbn_count">WBNs</th>
                            <th>Remarks</th>
                        </tr></thead>
                        <tbody>
                            ${bags.map(bag => {
                                let wbnDisplay = (viewType === 'cluster') ? `${bag.wbn_count_for_cluster || 0} / ${bag.wbn_count_per_bag || 0}` : (bag.wbn_count || 0);
                                return `
                                <tr data-bag-id="${bag.bag_id}" data-age-str="${bag.age_str}">
                                    <td><a href="${BAG_HQ_BASE_URL}${bag.bag_id}" target="_blank" class="text-blue-600 hover:underline">${bag.bag_id}${bag.is_bfsi ? '<span class="bfsi-icon">$</span>' : ''}</a></td>
                                    <td>${bag.age_str}</td>
                                    <td>${wbnDisplay}</td>
                                    <td><textarea class="remarks-textarea" data-bag-id="${bag.bag_id}" data-bag-age="${bag.age_str}"></textarea></td>
                                </tr>`
                            }).join('')}
                        </tbody>
                    </table>`;
                
                detailViewButtons.classList.remove('hidden');
            }
            
            function renderClusterSummaryTable(clusterDetails) {
                if (!clusterDetails || Object.keys(clusterDetails).length === 0) {
                    clusterSummaryListDiv.innerHTML = '<p class="text-gray-500 p-4">No cluster data available.</p>';
                    return;
                }

                const clusterArray = Object.entries(clusterDetails).map(([id, details]) => ({ id, bags: details.bag_id_count, wbns: details.wbn_count }));
                clusterArray.sort((a, b) => b.wbns - a.wbns);

                clusterSummaryListDiv.innerHTML = `
                    <table class="data-table">
                        <thead><tr><th>Cluster ID</th><th>Pending Bags</th><th>Pending WBNs</th></tr></thead>
                        <tbody>
                            ${clusterArray.map(cluster => `
                                <tr class="clickable-row hover:bg-blue-50" data-cluster-id="${cluster.id}">
                                    <td class="font-semibold text-gray-800">${cluster.id}</td>
                                    <td>${cluster.bags}</td>
                                    <td>${cluster.wbns}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;

                document.querySelectorAll('#clusterSummaryList tr[data-cluster-id]').forEach(row => {
                    row.addEventListener('click', e => {
                        const clusterId = e.currentTarget.dataset.clusterId;
                        const clusterData = window.currentAnalysisData.cluster_details[clusterId];
                        if (clusterData) {
                            detailViewTitle.textContent = `Bags in Cluster: ${clusterId} (${clusterData.bag_id_count} Bags, ${clusterData.wbn_count} WBNs)`;
                            renderBagTable(detailViewListDiv, clusterData.bags, 'cluster');
                            document.getElementById('detailViewContent').classList.add('open');
                        }
                    });
                });
            }

            // --- Event Listeners ---
            if(uploadAndAnalyzeButton) {
                uploadAndAnalyzeButton.addEventListener('click', async () => {
                    const file = fileUploadInput.files[0];
                    if (!file) {
                        showMessage(messageArea, 'Please select a CSV file.', true);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        uploadedCsvContent = e.target.result;
                        uploadedFileName = file.name;
                        await analyzeData(uploadedCsvContent, uploadedFileName);
                    };
                    reader.onerror = () => showMessage(messageArea, 'Failed to read file.', true);
                    reader.readAsText(file);
                });
            }

            copyAllButton.addEventListener('click', () => {
                const title = detailViewTitle.textContent;
                const allBags = Array.from(detailViewListDiv.querySelectorAll('tbody tr')).map(row => row.querySelector('td a').textContent.trim());
                if (allBags.length === 0) { showMessage(messageArea, 'No data to copy.', true); return; }
                navigator.clipboard.writeText(`${title}\n\n${allBags.join('\n')}`).then(() => {
                    showMessage(messageArea, `Copied all ${allBags.length} bag(s) to clipboard!`, false);
                });
            });

            copyRemarksButton.addEventListener('click', () => {
                const remarks = Array.from(detailViewListDiv.querySelectorAll('.remarks-textarea'))
                    .filter(t => t.value.trim() !== '')
                    .map(t => `Bag ID: ${t.dataset.bagId}\nAge: ${t.dataset.bagAge}\nRemarks: ${t.value.trim()}`);
                if (remarks.length === 0) { showMessage(messageArea, 'No remarks to copy.', true); return; }
                navigator.clipboard.writeText(remarks.join('\n\n---\n\n')).then(() => {
                    showMessage(messageArea, `Copied ${remarks.length} remark(s) to clipboard!`, false);
                });
            });
            
            function exportForOffline() {
                if (!window.currentAnalysisData) { showMessage(messageArea, "Please generate a dashboard first.", true); return; }
                const offlineHtmlTemplate = `<!DOCTYPE html><html lang="en"><head>${document.head.innerHTML}</head><body>${document.querySelector('.container').outerHTML}<script id="offline-script">window.embeddedData = ${JSON.stringify(window.currentAnalysisData)};const initializeApp = ${initializeApp.toString()};document.addEventListener('DOMContentLoaded', initializeApp);<\/script></body></html>`;
                const blob = new Blob([offlineHtmlTemplate], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mix_bag_dashboard_offline_${new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', '-')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            if(exportButton) exportButton.addEventListener('click', exportForOffline);
            
            addRuleBtn.addEventListener('click', createFilterRule);
            applyMagicFilterBtn.addEventListener('click', applyMagicFilter);

            setupCollapsibleHeaders();
        }
        
        initializeApp();
    </script>
</body>
</html>
